# Ralph Progress Log
Started: Mon Jan 26 09:29:51 UTC 2026
---
## Codebase Patterns
- Normalize LinkedIn URLs with `normalize_linkedin_url()` before dedupe and storage.
- Review API `/api/batches/{batch_id}/candidates` returns `custom_fields` and includes custom field values in standardized payloads.
- Role documents are stored under `uploads/roles/{role_id}` and tracked in `role_documents` via `/api/roles/{role_id}/documents`.
- Role criteria versions live in `role_criteria` with `/api/roles/{role_id}/criteria` for latest/create and `/api/roles/{role_id}/criteria/history` for version history.
- Test runs start at `POST /api/batches/{batch_id}/test-run` and are polled via `GET /api/test-runs/{test_run_id}`.
---
## 2026-01-26 09:37:48 UTC - FIX-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented grid-based field mapping interactions with strict high-confidence prefill rules and custom field support
- Files changed: webapp/static/map.js, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Patterns discovered: None
  - Gotchas encountered: Python is only available as `python3`; `pytest` is not installed in the environment
  - Useful context: Mapping UI now sends matrix payload `{mappings: {target: {filename: source_column}}, custom_fields: [...]}`
---

## Codebase Patterns
- Grid-based mapping UI: Rows = target fields, Columns = CSV files, Cells = dropdowns
- Payload format for grid: `{ mappings: {targetField: {filename: sourceCol}}, custom_fields: [] }`
- AI mapping suggestions only applied for HIGH confidence (exact/near-exact matches)
- Custom fields stored in standardized_data JSON alongside standard fields
- LinkedIn URL is always required for standardization
- Smart name splitting: "John Smith" → first/last, "Madonna" → first only, blank last
- Backend converts grid format to file-centric format internally for processing
- Sticky table positioning creates frozen panes effect for large grids

---

## 2026-01-26 (Extended) - FIX-001 Complete Implementation
- What was implemented:
  - Complete redesign of field mapping page from file-centric to grid-based layout
  - Grid with rows=target fields, columns=uploaded CSV files
  - Each cell has dropdown with (blank) + all source columns from that file
  - Add Custom Field button allows dynamic addition of custom target fields
  - Custom fields shown with CUSTOM badge and × remove button
  - LinkedIn URL row highlighted with REQUIRED badge and yellow background
  - Apply Mappings button disabled until linkedin_url is mapped
  - High-confidence AI suggestions only (prevents bad guesses)
  - Full error handling with clear messages, preserves work on error
  - Mobile responsive with adjusted layout for small screens

- Files changed:
  - webapp/templates/map.html - New grid HTML structure with table
  - webapp/static/map.css - Complete CSS rewrite with sticky positioning
  - webapp/static/map.js - Complete JS rewrite for grid logic and new payload
  - webapp/main.py - Updated apply_batch_mappings() for new payload format
  - webapp/main.py - Enhanced apply_mappings_to_row() with smart name splitting

- **Learnings for future iterations:**
  - The batch workflow is: role → batch → upload CSVs → map fields → standardize → review
  - Sticky positioning on thead th + td.target-cell creates Excel-like frozen panes
  - Backend still uses file-centric mappings internally, grid format is UI-only
  - Custom fields don't require schema changes - stored in JSON column
  - High confidence = exact match or starts-with match (e.g., "first_name" matches "firstname")
  - Name splitting handles edge cases: single names, middle names, empty last names
  - Mobile requires disabling sticky positioning to prevent layout issues

---
## 2026-01-26 09:42:35 UTC - FIX-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Updated apply-mappings backend to validate grid payload, normalize LinkedIn URLs, split names with AI fallback, and return standardized/duplicate counts
- Added detailed logging around mapping application and file processing
- Files changed: webapp/main.py, scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Patterns discovered: Use `normalize_linkedin_url()` before dedupe so stored LinkedIn URLs are consistent
  - Gotchas encountered: `pytest` is not installed in the environment (use `python3`, not `python`)
  - Useful context: Name splitting uses AI for 3+ part names with cached results; falls back to heuristic on failure
---
## 2026-01-26 09:58:26 UTC - FIX-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
- Added custom-field-aware review data payloads and grid rendering for standardized/comparison tabs
- Added export-duplicates action and read-only batch name display on review page
- Files changed
- webapp/main.py
- webapp/static/review.js
- webapp/templates/review.html
- scripts/ralph/prd.json
- scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Review UI builds columns from standard fields plus `custom_fields` returned by the review API
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Remember to exclude `full_name` from the review display even though it exists in the standardized payload
  - Useful context (e.g., "the evaluation panel is in component X")
    - Duplicate exports are available via `/api/batches/{batch_id}/duplicates/export`
---
## 2026-01-26 10:08:06 UTC - ADD-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
- Added role document storage (DB + API) with upload/replace/delete flows and URL intake support
- Updated role detail UI with a Role Documents section and per-type upload slots
- Files changed
- AGENTS.md
- database/schema.sql
- scripts/ralph/prd.json
- scripts/ralph/progress.txt
- tasks/us-000a-database-schema.md
- webapp/db.py
- webapp/main.py
- webapp/templates/role.html
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Role documents live in `role_documents` and are managed through `/api/roles/{role_id}/documents`
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Avoid deleting newly written files when replacing a document with the same path
  - Useful context (e.g., "the evaluation panel is in component X")
    - Intake uploads can be file-based or a Google Doc URL stored in `file_path`
---
## 2026-01-26 10:16:24 UTC - ADD-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
- Added role criteria storage/table plus API endpoints for latest and history
- Built criteria form UI with gating checkboxes, lock state, and save flow
- Files changed
- AGENTS.md
- database/schema.sql
- data.db
- scripts/ralph/prd.json
- scripts/ralph/progress.txt
- tasks/us-000a-database-schema.md
- webapp/db.py
- webapp/main.py
- webapp/templates/role.html
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Role criteria versions are stored in `role_criteria` with lock state enforced by `is_locked`
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Run `python3 database/migrate.py --sql database/schema.sql` when adding tables so `data.db` stays in sync
  - Useful context (e.g., "the evaluation panel is in component X")
    - Criteria form pulls `/api/roles/{role_id}/criteria` for prefill and posts JSON arrays back on save
---
## 2026-01-26 10:23:48 UTC - ADD-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
- Added document analysis endpoint to extract criteria suggestions from JD/intake/calibration files via Claude
- Added Analyze Documents UI with spinner and auto-fill logic for criteria form
- Added PDF/DOCX text extraction dependencies
- Files changed
- webapp/main.py
- webapp/templates/role.html
- requirements.txt
- scripts/ralph/prd.json
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - None
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - None
  - Useful context (e.g., "the evaluation panel is in component X")
    - Analyze endpoint: POST `/api/roles/{role_id}/analyze-documents` returns arrays for must_haves, gating_params, nice_to_haves
---
## 2026-01-26 12:25:35 UTC - ADD-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
- Added test run start endpoint, polling status endpoint, and criteria lock API
- Built test run UI with progress polling, summary counts, and expandable results table
- Wired background evaluation for 50 randomized standardized candidates
- Files changed
- AGENTS.md
- scripts/ralph/prd.json
- webapp/db.py
- webapp/main.py
- webapp/static/test_run.css
- webapp/static/test_run.js
- webapp/templates/test_run.html
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Start test runs via `/api/batches/{batch_id}/test-run` and poll `/api/test-runs/{test_run_id}` for progress/results
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Test runs require at least 50 standardized candidates; return a clear 400 if fewer are available
  - Useful context (e.g., "the evaluation panel is in component X")
    - Test run results render criteria columns from the criteria version data and allow row expansion for reasoning
---
