{
  "project": "Candidate Triage System - Fixes & Completion",
  "branchName": "ralph/fixes-and-completion",
  "description": "Fix broken functionality and add missing features. DO NOT rebuild working components. Human-driven workflow with AI assistance.",
  "learningInstructions": {
    "progressFile": "scripts/ralph/progress.txt",
    "agentsFile": "AGENTS.md",
    "rules": [
      "After EVERY story completion, append learnings to progress.txt",
      "If you discover a pattern or gotcha, update AGENTS.md",
      "If a story fails, document WHY in progress.txt before retrying",
      "If you make a mistake, document what went wrong and how to avoid it",
      "Read progress.txt at start of each iteration to remember past learnings"
    ]
  },
  "existingFunctionality": {
    "note": "These features EXIST. Do not rebuild. Reference when building new features.",
    "working": [
      "Database: candidate_batches, raw_candidates, batch_file_uploads tables",
      "CSV upload: POST /api/roles/:role_id/batches/upload",
      "Roles CRUD: GET/POST /api/roles",
      "Batch status tracking: pending -> mapping -> standardized -> approved",
      "Export CSV: GET /api/batches/:batch_id/export",
      "Progress stepper: webapp/templates/components/stepper.html"
    ]
  },
  "userStories": [
    {
      "id": "FIX-001",
      "title": "Redesign Field Mapping Page - Grid Layout",
      "description": "Replace current mapping UI with a grid-based layout that's more intuitive. Human-driven with AI suggestions.",
      "acceptanceCriteria": [
        "SUCCESS: Page loads at /roles/:role_id/batches/:batch_id/map without errors",
        "SUCCESS: Grid layout displays with ROWS = target fields, COLUMNS = uploaded files",
        "SUCCESS: Target fields column (left side) shows: first_name, last_name, full_name, linkedin_url, location, current_company, current_title",
        "SUCCESS: Each uploaded file gets its own column with filename as header",
        "SUCCESS: Each cell contains a dropdown listing that file's CSV columns",
        "SUCCESS: Dropdown options are: (blank), plus all column headers from that file",
        "SUCCESS: AI pre-fills cells only if HIGH confidence match (exact or near-exact column name match)",
        "SUCCESS: AI leaves cell BLANK if uncertain - do not guess",
        "SUCCESS: 'Add Custom Field' button at bottom of target fields column",
        "SUCCESS: Clicking Add Custom Field prompts for field name, adds new row",
        "SUCCESS: Custom fields work the same as standard fields (can map source columns to them)",
        "SUCCESS: linkedin_url row highlighted as REQUIRED",
        "SUCCESS: 'Apply Mappings' button disabled until linkedin_url has at least one mapping",
        "SUCCESS: Clicking Apply Mappings calls POST /api/batches/:batch_id/apply-mappings with mapping matrix",
        "SUCCESS: On success, redirects to review page",
        "SUCCESS: On error, shows clear error message without losing user's work",
        "FAIL: Page shows error or doesn't load",
        "FAIL: Layout is not grid-based (rows=targets, cols=files)",
        "FAIL: AI fills in uncertain mappings instead of leaving blank",
        "FAIL: Cannot add custom fields",
        "FAIL: Apply Mappings fails silently"
      ],
      "priority": 1,
      "passes": true,
      "fileHints": [
        "webapp/templates/map.html",
        "webapp/static/map.js",
        "webapp/static/map.css",
        "webapp/main.py"
      ]
    },
    {
      "id": "FIX-002",
      "title": "Fix Apply Mappings Backend",
      "description": "Ensure mapping application works correctly with new grid format and handles edge cases.",
      "acceptanceCriteria": [
        "SUCCESS: POST /api/batches/:batch_id/apply-mappings accepts new grid format payload",
        "SUCCESS: Payload format: {mappings: {target_field: {filename: source_column, ...}, ...}, custom_fields: ['field1', ...]}",
        "SUCCESS: For each row in each CSV, extracts values based on mappings",
        "SUCCESS: If full_name mapped but not first/last, use AI to split intelligently (handles 'John Smith', 'John Michael Smith', 'Madonna')",
        "SUCCESS: Single names (no space) go to first_name, last_name left blank",
        "SUCCESS: LinkedIn URLs normalized to consistent format: https://linkedin.com/in/username",
        "SUCCESS: Handles all LinkedIn formats: full URL, partial URL, just username",
        "SUCCESS: Deduplicates by linkedin_url (case-insensitive), keeps first occurrence",
        "SUCCESS: Duplicates marked with status='duplicate' in database",
        "SUCCESS: Custom fields stored in standardized_data JSON",
        "SUCCESS: Returns {success: true, total: N, standardized: N, duplicates: N}",
        "SUCCESS: Logs detailed processing info for debugging",
        "FAIL: Mapping fails without clear error message",
        "FAIL: Name splitting produces wrong results",
        "FAIL: LinkedIn URLs not normalized",
        "FAIL: Duplicates not detected",
        "FAIL: Custom fields not saved"
      ],
      "priority": 2,
      "passes": true,
      "fileHints": [
        "webapp/main.py lines 637-720",
        "webapp/db.py"
      ]
    },
    {
      "id": "FIX-003",
      "title": "Fix Review Page",
      "description": "Ensure review page displays standardized data correctly with all columns.",
      "acceptanceCriteria": [
        "SUCCESS: Page loads at /roles/:role_id/batches/:batch_id/review without errors",
        "SUCCESS: Header shows: batch name, file count, total rows uploaded, duplicates removed, final count",
        "SUCCESS: Three tabs: Raw Data, Standardized Data, Comparison",
        "SUCCESS: Standardized tab shows columns: first_name, last_name, linkedin_url, location, current_company, current_title, plus any custom fields",
        "SUCCESS: Raw tab shows ALL original columns from source CSVs",
        "SUCCESS: Comparison tab shows side-by-side (raw left, standardized right)",
        "SUCCESS: Table is scrollable if many rows",
        "SUCCESS: 'View Duplicates' link shows modal/page with deduplicated candidates",
        "SUCCESS: 'Export CSV' button downloads standardized data",
        "SUCCESS: 'Export Duplicates' button downloads just the duplicates",
        "SUCCESS: 'Approve Batch' button calls POST /api/batches/:batch_id/approve",
        "SUCCESS: After approval, redirects to test run page",
        "FAIL: Page errors or shows no data",
        "FAIL: Standardized columns missing or wrong",
        "FAIL: Tabs don't switch correctly",
        "FAIL: Export doesn't work"
      ],
      "priority": 3,
      "passes": true,
      "fileHints": [
        "webapp/templates/review.html",
        "webapp/static/review.js",
        "webapp/main.py"
      ]
    },
    {
      "id": "ADD-001",
      "title": "Add Role Document Uploads",
      "description": "Role detail page needs document upload section for JD, intake form, and calibration candidates.",
      "acceptanceCriteria": [
        "SUCCESS: Database table created: role_documents (id, role_id, doc_type, filename, file_path, uploaded_at)",
        "SUCCESS: doc_type values: 'jd', 'intake', 'calibration'",
        "SUCCESS: API POST /api/roles/:role_id/documents accepts file upload + doc_type",
        "SUCCESS: JD accepts: PDF, DOCX, TXT files",
        "SUCCESS: Intake accepts: PDF, DOCX, TXT files, or Google Doc URL (stored as text)",
        "SUCCESS: Calibration accepts: CSV files only",
        "SUCCESS: Files saved to uploads/roles/{role_id}/{doc_type}_{filename}",
        "SUCCESS: API GET /api/roles/:role_id/documents returns list with metadata",
        "SUCCESS: API DELETE /api/roles/:role_id/documents/:doc_id removes file and record",
        "SUCCESS: Role detail page shows 'Role Documents' section at TOP",
        "SUCCESS: Three upload slots: Job Description, Intake Form, Calibration Candidates",
        "SUCCESS: Empty slot shows 'Not uploaded' + Upload button",
        "SUCCESS: Filled slot shows filename + Replace + Delete buttons",
        "SUCCESS: Uploading new file to filled slot REPLACES the old one",
        "SUCCESS: Only ONE of each doc type per role (replace, not add)",
        "FAIL: Database table missing or wrong schema",
        "FAIL: File upload fails",
        "FAIL: Can't replace existing document",
        "FAIL: UI doesn't show document status"
      ],
      "priority": 4,
      "passes": true,
      "fileHints": [
        "webapp/templates/role.html",
        "webapp/main.py",
        "webapp/db.py",
        "database/schema.sql"
      ]
    },
    {
      "id": "ADD-002",
      "title": "Add Criteria Configuration Form",
      "description": "Role detail page needs criteria configuration form below documents section.",
      "acceptanceCriteria": [
        "SUCCESS: Database table created: role_criteria (id, role_id, version, must_haves JSON, gating_params JSON, nice_to_haves JSON, is_locked BOOL, created_at)",
        "SUCCESS: API POST /api/roles/:role_id/criteria saves new criteria version",
        "SUCCESS: API GET /api/roles/:role_id/criteria returns latest criteria (or null)",
        "SUCCESS: API GET /api/roles/:role_id/criteria/history returns all versions",
        "SUCCESS: Role detail page shows 'Filtering Criteria' section below documents",
        "SUCCESS: Section header shows current version number if criteria exists",
        "SUCCESS: Form has three areas: Must-Have Requirements, Gating Parameters, Nice-to-Haves",
        "SUCCESS: Must-Haves: textarea, free-form text (one requirement per line)",
        "SUCCESS: Gating Parameters section has checkboxes:",
        "  - [ ] Job hopper (>3 jobs in 5 years)",
        "  - [ ] Bootcamp-only education (no degree)",
        "  - [ ] Location mismatch",
        "  - Custom rule: [text input]",
        "SUCCESS: Nice-to-Haves: textarea, free-form text (one per line)",
        "SUCCESS: 'Save Criteria' button creates new version, shows 'Saved as v{N}'",
        "SUCCESS: If criteria exists, form pre-populated with latest version",
        "SUCCESS: If criteria is_locked=true, form is READ-ONLY with message 'Criteria locked after approved test run'",
        "SUCCESS: Criteria editable until test run is APPROVED, then locked",
        "FAIL: Database table missing",
        "FAIL: Form doesn't save",
        "FAIL: Locked criteria can still be edited"
      ],
      "priority": 5,
      "passes": true,
      "fileHints": [
        "webapp/templates/role.html",
        "webapp/main.py",
        "webapp/db.py",
        "database/schema.sql"
      ]
    },
    {
      "id": "ADD-003",
      "title": "Add AI Criteria Extraction",
      "description": "Button to analyze uploaded documents and suggest criteria using AI.",
      "acceptanceCriteria": [
        "SUCCESS: 'Analyze Documents' button appears when JD is uploaded",
        "SUCCESS: Button disabled if no JD uploaded, tooltip explains why",
        "SUCCESS: API POST /api/roles/:role_id/analyze-documents",
        "SUCCESS: Backend reads JD file (required), intake and calibration if present",
        "SUCCESS: For PDF: extract text using PyPDF2 or pdfplumber",
        "SUCCESS: For DOCX: extract text using python-docx",
        "SUCCESS: For TXT: read directly",
        "SUCCESS: Send extracted text to Claude with prompt requesting: must-haves, gating params, nice-to-haves",
        "SUCCESS: Claude returns structured JSON",
        "SUCCESS: API returns {must_haves: [...], gating_params: [...], nice_to_haves: [...]}",
        "SUCCESS: Frontend populates form fields with AI suggestions",
        "SUCCESS: Loading spinner shown during analysis (10-30 seconds typical)",
        "SUCCESS: User can edit suggestions before saving",
        "SUCCESS: If analysis fails, show error message, don't crash",
        "FAIL: Button appears when no JD",
        "FAIL: PDF/DOCX text extraction fails",
        "FAIL: AI call fails without graceful error",
        "FAIL: Form not populated with results"
      ],
      "priority": 6,
      "passes": true,
      "fileHints": [
        "webapp/main.py",
        "webapp/templates/role.html",
        "requirements.txt"
      ]
    },
    {
      "id": "ADD-004",
      "title": "Add Test Run - 50 Candidates",
      "description": "After approving batch, run AI evaluation on 50 random candidates to validate criteria.",
      "acceptanceCriteria": [
        "SUCCESS: Page /roles/:role_id/batches/:batch_id/test-run shows test interface",
        "SUCCESS: Page shows: role name, criteria version, batch name, candidate count",
        "SUCCESS: 'Run Test (50 candidates)' button initiates test",
        "SUCCESS: API POST /api/batches/:batch_id/test-run",
        "SUCCESS: Backend selects 50 RANDOM candidates from batch (status='standardized')",
        "SUCCESS: Create filtering/evaluator.py with evaluate_candidate() function",
        "SUCCESS: evaluate_candidate(candidate, criteria) calls Claude API",
        "SUCCESS: Claude evaluates candidate against EACH must-have, gating param, nice-to-have",
        "SUCCESS: Each criteria returns: Pass, Fail, or Unsure + one-sentence reason",
        "SUCCESS: Final bucket determined by logic:",
        "  1. If can't evaluate (missing data) -> 'Unable to Enrich'",
        "  2. If ANY gating param triggered -> 'Dismiss'",
        "  3. If ANY must-have = Fail -> 'Dismiss'",
        "  4. If ALL must-haves = Pass -> 'Proceed'",
        "  5. If must-haves are Pass/Unsure mix (at least one Unsure) -> 'Human Review'",
        "SUCCESS: Nice-to-haves evaluated but DON'T affect bucket (informational only)",
        "SUCCESS: Progress shown during evaluation: 'Evaluated X of 50...'",
        "SUCCESS: Results displayed in table: Name, LinkedIn, criteria columns (color coded), Bucket",
        "SUCCESS: Color coding: green=Pass, red=Fail, yellow=Unsure",
        "SUCCESS: Click row to expand and see detailed reasoning",
        "SUCCESS: Summary bar: X Proceed, X Human Review, X Dismiss, X Unable to Enrich",
        "SUCCESS: 'Refine Criteria' button goes back to role page (criteria still editable)",
        "SUCCESS: 'Approve Criteria & Run Full' button locks criteria and goes to full run page",
        "SUCCESS: Store results in test_run_results table",
        "FAIL: Not exactly 50 candidates selected",
        "FAIL: Bucket logic wrong",
        "FAIL: Can't see reasoning per criteria",
        "FAIL: Criteria not locked when approving"
      ],
      "priority": 7,
      "passes": true,
      "fileHints": [
        "webapp/main.py",
        "webapp/templates/test_run.html",
        "filtering/evaluator.py (CREATE)"
      ]
    },
    {
      "id": "ADD-005",
      "title": "Add Full Run & Results Page",
      "description": "After test validation, run on full list and display results with reasoning.",
      "acceptanceCriteria": [
        "SUCCESS: Page /roles/:role_id/batches/:batch_id/run shows run options",
        "SUCCESS: Radio buttons: 'Run on all X candidates' or 'Run on subset: [input] candidates'",
        "SUCCESS: 'Start Filtering' button initiates run",
        "SUCCESS: API POST /api/batches/:batch_id/run-full?count=N",
        "SUCCESS: count=0 or omitted means ALL candidates",
        "SUCCESS: Backend processes candidates using same evaluate_candidate() function",
        "SUCCESS: Progress stored in database, queryable via API",
        "SUCCESS: Frontend shows progress: 'Evaluated X of Y... ~Z minutes remaining'",
        "SUCCESS: User can navigate away, run continues in background",
        "SUCCESS: On completion, auto-redirect to results page",
        "SUCCESS: Results page: /roles/:role_id/batches/:batch_id/results",
        "SUCCESS: Summary cards at top: Proceed (N), Human Review (N), Dismiss (N), Unable to Enrich (N)",
        "SUCCESS: Click card filters table to that bucket",
        "SUCCESS: Table columns: Name, LinkedIn, Location, Company, Title, Bucket (badge)",
        "SUCCESS: Click row to expand: shows each criteria with Pass/Fail/Unsure + reason",
        "SUCCESS: Filter dropdown: All, Proceed, Human Review, Dismiss, Unable to Enrich",
        "SUCCESS: Export buttons: 'Export All', 'Export Proceed', 'Export Human Review', 'Export Dismiss'",
        "SUCCESS: Export CSV includes: all candidate fields, each criteria result, reasoning, bucket",
        "SUCCESS: Results stored in filter_results table for history",
        "FAIL: Progress not shown",
        "FAIL: Background processing doesn't work",
        "FAIL: Can't filter by bucket",
        "FAIL: Export missing criteria/reasoning columns"
      ],
      "priority": 8,
      "passes": true,
      "fileHints": [
        "webapp/main.py",
        "webapp/templates/run.html",
        "webapp/templates/results.html (CREATE)"
      ]
    },
    {
      "id": "ADD-006",
      "title": "UI Polish - Clean Professional Design",
      "description": "Apply consistent, clean design across all pages. Modern but not over-designed.",
      "acceptanceCriteria": [
        "SUCCESS: Create webapp/static/design-system.css with variables and base styles",
        "SUCCESS: Color scheme applied consistently:",
        "  - Primary: #0b57d0 (blue)",
        "  - Success: #1e8e3e (green) - for Pass, Proceed",
        "  - Warning: #f9ab00 (yellow) - for Unsure, Human Review",
        "  - Error: #d93025 (red) - for Fail, Dismiss",
        "  - Neutral: #5f6368 (gray) - for secondary text",
        "SUCCESS: All cards: 1px solid #e0e0e0 border, 8px border-radius, 20px padding, subtle shadow",
        "SUCCESS: All buttons: consistent sizing, border-radius 6px, hover state (darken 10%)",
        "SUCCESS: All tables: header with #f8f9fa background, alternating row colors, hover highlight",
        "SUCCESS: All forms: proper label spacing (8px), focus ring on inputs, error state styling",
        "SUCCESS: All async operations show loading spinner",
        "SUCCESS: Success actions show green toast notification (auto-dismiss 3s)",
        "SUCCESS: Error actions show red toast notification with message",
        "SUCCESS: Breadcrumbs on all pages: Home > Role Name > Batch Name > Current Step",
        "SUCCESS: Empty states: helpful message + primary action button",
        "SUCCESS: Status badges: consistent pill style with appropriate colors",
        "SUCCESS: Mobile responsive: single column layout under 768px",
        "FAIL: Inconsistent colors across pages",
        "FAIL: No loading states",
        "FAIL: No error feedback to user",
        "FAIL: Broken on mobile"
      ],
      "priority": 9,
      "passes": true,
      "fileHints": [
        "webapp/static/*.css",
        "webapp/templates/*.html"
      ]
    }
  ]
}
